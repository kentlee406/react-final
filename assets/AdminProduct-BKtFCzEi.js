import{r as n,k as e}from"./vendor-DCgf3J4u.js";import{b as L}from"./vendor-router-BS-I_zzl.js";import{a as u}from"./vendor-axios-B9ygI19o.js";import{M as E}from"./vendor-bootstrap-DsuGXcVh.js";import{a as _,u as P}from"./index-DkW-5-gO.js";import{f as S}from"./formatApiErrorMessage-CWn7tMz1.js";import{P as F}from"./Pagination-D75gfH_0.js";import{g as D,c as T}from"./authToken-DvrakIaH.js";import"./vendor-redux-B-LDsaQv.js";const A="https://ec-course-api.hexschool.io/v2",M="kentlee406";function z({mode:r,tempProduct:i,getProductData:g}){const{showLoading:d,hideLoading:x}=n.useContext(_),{showNotification:m}=P(),[s,h]=n.useState({...i,imagesUrl:i.imagesUrl||["","","",""]}),[N,v]=n.useState(""),[y,w]=n.useState(!1),p=n.useRef(null),b=n.useRef(null);n.useEffect(()=>{const a=i.imagesUrl?[...i.imagesUrl]:[];for(;a.length<4;)a.push("");h({...i,imagesUrl:a})},[i]),n.useEffect(()=>(p.current&&(b.current=new E(p.current,{backdrop:"static"})),()=>{b.current&&b.current.dispose()}),[]);const c=a=>{const{id:l,value:o,type:f,checked:I}=a.target;h(U=>({...U,[l]:f==="checkbox"?I?1:0:f==="number"?Number(o):o}))},j=async a=>{const l=a.target.files?.[0];if(!l)return;const o=new FormData;o.append("file-to-upload",l);try{w(!0),d();const I=(await u.post(`${A}/api/${M}/admin/upload`,o)).data?.imageUrl;if(!I)throw new Error("上傳成功但未取得圖片網址");h(U=>({...U,imageUrl:I})),m("主圖上傳成功","success",6e3)}catch(f){m("主圖上傳失敗："+(f.response?.data?.message||f.message||"未知錯誤"),"error",8e3)}finally{w(!1),x(),a.target.value=""}},C=()=>{if(!N.trim())return;const a=[...s.imagesUrl],l=a.findIndex(o=>o==="");l!==-1?(a[l]=N,h(o=>({...o,imagesUrl:a})),v("")):alert("最多只能上傳 4 張圖片")},k=a=>{const l=[...s.imagesUrl];l[a]="",h(o=>({...o,imagesUrl:l}))},t=async()=>{try{d();const a=r==="create"?`${A}/api/${M}/admin/product`:`${A}/api/${M}/admin/product/${s.id}`;await u[r==="create"?"post":"put"](a,{data:s}),m(r==="create"?"新增成功":"更新成功","success",6e3),await g(),b.current.hide()}catch(a){const l=S(a.response?.data?.message||"未知錯誤");m("操作失敗："+l,"error",8e3)}finally{x()}};return e.jsx("div",{className:"modal fade ",ref:p,id:"ProductModal",tabIndex:"-1","aria-labelledby":"exampleModalLabel","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"新增產品"}),e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"modal"})]}),e.jsx("div",{className:"modal-body",children:e.jsx("div",{className:"container",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-lg-7",children:e.jsxs("form",{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"title",className:"form-label fw-bold",children:"商品名稱"}),e.jsx("input",{type:"text",className:"form-control",id:"title",placeholder:"請輸入商品名稱",value:s.title||"",onChange:c})]}),e.jsxs("div",{className:"row mb-3",children:[e.jsxs("div",{className:"col-6",children:[e.jsx("label",{htmlFor:"origin_price",className:"form-label fw-bold",children:"原價"}),e.jsx("input",{type:"number",className:"form-control",id:"origin_price",min:"0",value:s.origin_price??0,onChange:c})]}),e.jsxs("div",{className:"col-6",children:[e.jsx("label",{htmlFor:"price",className:"form-label fw-bold",children:"售價"}),e.jsx("input",{type:"number",className:"form-control",id:"price",min:"0",value:s.price??0,onChange:c})]})]}),e.jsxs("div",{className:"row mb-3",children:[e.jsxs("div",{className:"col-6",children:[e.jsx("label",{htmlFor:"category",className:"form-label fw-bold",children:"分類"}),e.jsx("input",{type:"text",className:"form-control",id:"category",value:s.category||"",onChange:c})]}),e.jsxs("div",{className:"col-6",children:[e.jsx("label",{htmlFor:"unit",className:"form-label fw-bold",children:"單位"}),e.jsx("input",{type:"text",className:"form-control",id:"unit",value:s.unit||"",onChange:c})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"content",className:"form-label fw-bold",children:"商品內容"}),e.jsx("textarea",{className:"form-control",id:"content",rows:"4",value:s.content||"",onChange:c})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"description",className:"form-label fw-bold",children:"商品描述"}),e.jsx("textarea",{className:"form-control",id:"description",rows:"4",value:s.description||"",onChange:c})]}),e.jsxs("div",{className:"form-check form-switch",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"is_enabled",checked:!!s.is_enabled,onChange:c}),e.jsx("label",{className:"form-check-label fw-bold",htmlFor:"is_enabled",children:"啟用"})]})]})}),e.jsxs("div",{className:"col-lg-5",children:[e.jsx("label",{htmlFor:"mainImageUpload",className:"form-label fw-bold",children:"商品主圖（檔案上傳）"}),e.jsx("input",{type:"file",className:"form-control mb-2",id:"mainImageUpload",accept:"image/*",onChange:j,disabled:y}),y&&e.jsx("small",{className:"text-muted d-block mb-2",children:"主圖上傳中..."}),s.imageUrl?e.jsx("div",{className:"border rounded bg-light d-flex align-items-center justify-content-center mb-3",style:{height:"160px",overflow:"hidden"},children:e.jsx("img",{src:s.imageUrl,alt:"主圖預覽",className:"w-100 h-100 object-fit-cover",onError:a=>{a.target.src="https://via.placeholder.com/300x160?text=Invalid+Image"}})}):e.jsx("small",{className:"text-muted d-block mb-3",children:"尚未上傳主圖"}),e.jsx("label",{className:"form-label fw-bold",children:"其他圖片 (最多 4 張)"}),e.jsxs("div",{className:"input-group mb-3",children:[e.jsx("input",{type:"text",className:"form-control",placeholder:"輸入圖片連結",value:N,onChange:a=>v(a.target.value)}),e.jsx("button",{className:"btn btn-outline-primary",type:"button",onClick:C,children:"新增連結"})]}),e.jsx("div",{className:"row g-2",children:s.imagesUrl.map((a,l)=>e.jsx("div",{className:"col-6",children:e.jsx("div",{className:"border rounded bg-light d-flex align-items-center justify-content-center position-relative",style:{height:"100px",overflow:"hidden"},children:a?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:a,alt:"預覽圖",className:"w-100 h-100 object-fit-cover",onError:o=>{o.target.src="https://via.placeholder.com/150?text=Invalid+URL"}}),e.jsx("button",{type:"button",className:"btn btn-danger btn-sm position-absolute top-0 end-0 p-1",style:{fontSize:"10px",lineHeight:1},onClick:()=>k(l),children:"✕"})]}):e.jsxs("small",{className:"text-muted",children:["圖片 ",l+1]})})},l))})]})]})})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary","data-bs-dismiss":"modal",children:"關閉"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:t,children:"存檔"})]})]})})})}const R="https://ec-course-api.hexschool.io/v2",B="kentlee406";function H({getProductData:r,tempProduct:i}){const{showLoading:g,hideLoading:d}=n.useContext(_),{showNotification:x}=P(),m=async()=>{try{g(),await u.delete(`${R}/api/${B}/admin/product/${i.id}`),x("刪除成功","success",6e3),await r()}catch(s){const h=S(s.response?.data?.message||"發生錯誤");x(`刪除失敗：${h}`,"error",8e3)}finally{d()}};return e.jsx("div",{className:"modal fade",id:"deleteModal",tabIndex:"-1","aria-labelledby":"deleteModalLabel","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content border-0",children:[e.jsxs("div",{className:"modal-header bg-danger text-white",children:[e.jsx("h5",{className:"modal-title",id:"deleteModalLabel",children:e.jsx("span",{children:"刪除產品"})}),e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})]}),e.jsxs("div",{className:"modal-body",children:["是否刪除",e.jsxs("strong",{className:"text-danger",children:[" ",i.title," "]}),"(刪除後將無法恢復)。"]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary","data-bs-dismiss":"modal",children:"取消"}),e.jsx("button",{type:"button",className:"btn btn-danger",onClick:m,"data-bs-dismiss":"modal",children:"確認刪除"})]})]})})})}const $="https://ec-course-api.hexschool.io/v2",O="kentlee406";function Z(){const r=L(),{showLoading:i,hideLoading:g}=n.useContext(_),{showNotification:d}=P(),[x,m]=n.useState(1),[s,h]=n.useState([]),[N,v]=n.useState({}),[y,w]=n.useState(""),[p,b]=n.useState({id:"",imageUrl:"",title:"",category:"",unit:"",origin_price:"",price:"",description:"",content:"",is_enabled:!1,imagesUrl:[]}),c=(t,a)=>{w(t),b(t==="create"?{title:"",category:"",unit:"",origin_price:0,price:0,description:"",content:"",is_enabled:0,imageUrl:"",imagesUrl:[""]}:a);const l=document.getElementById("ProductModal");E.getOrCreateInstance(l).show()},j=async(t=x)=>{try{i();const a=await u.get(`${$}/api/${O}/admin/products?page=${t}`);h(a.data.products),v(a.data.pagination),m(a.data.pagination.current_page)}catch{d("取得後台產品資料失敗，請稍後再試","error",8e3)}finally{g()}},C=async()=>{const t=D();if(!t){d("登入狀態已失效，請重新登入","error",8e3),r("/login");return}try{i(),u.defaults.headers.common.Authorization=t,await u.post(`${$}/api/user/check`),await j(1)}catch{u.defaults.headers.common.Authorization="",d("登入狀態已失效，請重新登入","error",8e3),r("/login")}finally{g()}},k=async()=>{try{i(),await u.post(`${$}/logout`),T(),u.defaults.headers.common.Authorization="",r("/login")}catch{d("登出失敗，請稍後再試","error",8e3)}finally{g()}};return n.useEffect(()=>{C()},[]),e.jsxs("div",{className:"container",children:[e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-8",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("h2",{className:"fw-bold",children:"產品列表"}),e.jsxs("div",{children:[e.jsx("button",{className:"btn btn-success me-2",onClick:()=>c("create"),children:"新增產品"}),e.jsx("button",{className:"btn btn-success me-2",onClick:()=>r("/admin/order"),children:"訂單管理"}),e.jsx("button",{className:"btn btn-danger",onClick:k,children:"登出"})]})]}),e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"分類"}),e.jsx("th",{children:"產品名稱"}),e.jsx("th",{children:"原價"}),e.jsx("th",{children:"售價"}),e.jsx("th",{children:"是否啟用"}),e.jsx("th",{children:"編輯"}),e.jsx("th",{children:"刪除"})]})}),e.jsx("tbody",{children:s&&s.length>0?s.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.category}),e.jsx("td",{children:t.title}),e.jsx("td",{children:t.origin_price}),e.jsx("td",{children:t.price}),e.jsx("td",{children:t.is_enabled?"啟用":"未啟用"}),e.jsx("td",{children:e.jsx("button",{className:"btn btn-primary",onClick:()=>c("edit",t),children:"編輯"})}),e.jsx("td",{children:e.jsx("button",{type:"button",className:"btn btn-danger",id:"delete"+t.id,onClick:()=>b(t),"data-bs-target":"#deleteModal","data-bs-toggle":"modal",children:"刪除"})})]},t.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:"7",children:"尚無產品資料"})})})]})]})}),e.jsx(F,{products:s,pagination:N,currentPage:x,setCurrentPage:m,onPageChange:j}),e.jsx(z,{mode:y,tempProduct:p,getProductData:j}),e.jsx(H,{getProductData:j,tempProduct:p})]})}export{Z as default};
