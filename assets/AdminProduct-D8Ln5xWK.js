import{r as n,k as e}from"./vendor-DCgf3J4u.js";import{b as D}from"./vendor-router-BS-I_zzl.js";import{a as h}from"./vendor-axios-B9ygI19o.js";import{M as F}from"./vendor-bootstrap-DsuGXcVh.js";import{a as P,u as S}from"./index-DAGqcCRM.js";import{f as L}from"./formatApiErrorMessage-CWn7tMz1.js";import{P as T}from"./Pagination-D75gfH_0.js";import{g as z,c as R}from"./authToken-DvrakIaH.js";import"./vendor-redux-B-LDsaQv.js";const C="https://ec-course-api.hexschool.io/v2",$="kentlee406";function B({mode:d,tempProduct:r,getProductData:f}){const{showLoading:m,hideLoading:b}=n.useContext(P),{showNotification:i}=S(),[s,u]=n.useState({...r,imagesUrl:r.imagesUrl||["","","",""]}),[w,y]=n.useState(!1),[I,U]=n.useState(-1),j=n.useRef(null),p=n.useRef(null);n.useEffect(()=>{const a=r.imagesUrl?[...r.imagesUrl]:[];for(;a.length<4;)a.push("");u({...r,imagesUrl:a})},[r]),n.useEffect(()=>(j.current&&(p.current=new F(j.current,{backdrop:"static"})),()=>{p.current&&p.current.dispose()}),[]);const c=a=>{const{id:t,value:o,type:g,checked:x}=a.target;u(v=>({...v,[t]:g==="checkbox"?x?1:0:g==="number"?Number(o):o}))},N=async a=>{const t=a.target.files?.[0];if(!t)return;const o=new FormData;o.append("file-to-upload",t);try{y(!0),m();const x=(await h.post(`${C}/api/${$}/admin/upload`,o)).data?.imageUrl;if(!x)throw new Error("上傳成功但未取得圖片網址");u(v=>({...v,imageUrl:x})),i("主圖上傳成功","success",6e3)}catch(g){i("主圖上傳失敗："+(g.response?.data?.message||g.message||"未知錯誤"),"error",8e3)}finally{y(!1),b(),a.target.value=""}},A=async(a,t)=>{const o=t.target.files?.[0];if(!o)return;const g=new FormData;g.append("file-to-upload",o);try{U(a),m();const v=(await h.post(`${C}/api/${$}/admin/upload`,g)).data?.imageUrl;if(!v)throw new Error("上傳成功但未取得圖片網址");u(E=>{const k=[...E.imagesUrl||["","","",""]];for(;k.length<4;)k.push("");return k[a]=v,{...E,imagesUrl:k}}),i(`圖片 ${a+1} 上傳成功`,"success",6e3)}catch(x){i(`圖片 ${a+1} 上傳失敗：`+(x.response?.data?.message||x.message||"未知錯誤"),"error",8e3)}finally{U(-1),b(),t.target.value=""}},M=a=>{const t=[...s.imagesUrl];t[a]="",u(o=>({...o,imagesUrl:t}))},l=async()=>{if(Number(s.origin_price)<Number(s.price)){i("原價不可小於售價","error",8e3);return}try{m();const a=d==="create"?`${C}/api/${$}/admin/product`:`${C}/api/${$}/admin/product/${s.id}`;await h[d==="create"?"post":"put"](a,{data:s}),i(d==="create"?"新增成功":"更新成功","success",6e3),await f(),p.current.hide()}catch(a){const t=L(a.response?.data?.message||"未知錯誤");i("操作失敗："+t,"error",8e3)}finally{b()}};return e.jsx("div",{className:"modal fade ",ref:j,id:"ProductModal",tabIndex:"-1","aria-labelledby":"exampleModalLabel","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"新增產品"}),e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"modal"})]}),e.jsx("div",{className:"modal-body",children:e.jsx("div",{className:"container",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-lg-7",children:e.jsxs("form",{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"title",className:"form-label fw-bold",children:"商品名稱"}),e.jsx("input",{type:"text",className:"form-control",id:"title",placeholder:"請輸入商品名稱",value:s.title||"",onChange:c})]}),e.jsxs("div",{className:"row mb-3",children:[e.jsxs("div",{className:"col-6",children:[e.jsx("label",{htmlFor:"origin_price",className:"form-label fw-bold",children:"原價"}),e.jsx("input",{type:"number",className:"form-control",id:"origin_price",min:"0",value:s.origin_price??0,onChange:c})]}),e.jsxs("div",{className:"col-6",children:[e.jsx("label",{htmlFor:"price",className:"form-label fw-bold",children:"售價"}),e.jsx("input",{type:"number",className:"form-control",id:"price",min:"0",value:s.price??0,onChange:c})]})]}),e.jsxs("div",{className:"row mb-3",children:[e.jsxs("div",{className:"col-6",children:[e.jsx("label",{htmlFor:"category",className:"form-label fw-bold",children:"分類"}),e.jsx("input",{type:"text",className:"form-control",id:"category",value:s.category||"",onChange:c})]}),e.jsxs("div",{className:"col-6",children:[e.jsx("label",{htmlFor:"unit",className:"form-label fw-bold",children:"單位"}),e.jsx("input",{type:"text",className:"form-control",id:"unit",value:s.unit||"",onChange:c})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"content",className:"form-label fw-bold",children:"商品內容"}),e.jsx("textarea",{className:"form-control",id:"content",rows:"4",value:s.content||"",onChange:c})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"description",className:"form-label fw-bold",children:"商品描述"}),e.jsx("textarea",{className:"form-control",id:"description",rows:"4",value:s.description||"",onChange:c})]}),e.jsxs("div",{className:"form-check form-switch",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"is_enabled",checked:!!s.is_enabled,onChange:c}),e.jsx("label",{className:"form-check-label fw-bold",htmlFor:"is_enabled",children:"啟用"})]})]})}),e.jsxs("div",{className:"col-lg-5",children:[e.jsx("label",{htmlFor:"mainImageUpload",className:"form-label fw-bold",children:"商品主圖（檔案上傳）"}),e.jsx("input",{type:"file",className:"form-control mb-2",id:"mainImageUpload",accept:"image/*",onChange:N,disabled:w}),w&&e.jsx("small",{className:"text-muted d-block mb-2",children:"主圖上傳中..."}),s.imageUrl?e.jsx("div",{className:"border rounded bg-light d-flex align-items-center justify-content-center mb-3",style:{height:"160px",overflow:"hidden"},children:e.jsx("img",{src:s.imageUrl,alt:"主圖預覽",className:"w-100 h-100 object-fit-cover",onError:a=>{a.target.src="https://via.placeholder.com/300x160?text=Invalid+Image"}})}):e.jsx("small",{className:"text-muted d-block mb-3",children:"尚未上傳主圖"}),e.jsx("label",{className:"form-label fw-bold",children:"其他圖片 (最多 4 張)"}),e.jsx("div",{className:"row g-2",children:s.imagesUrl.map((a,t)=>e.jsxs("div",{className:"col-6",children:[e.jsx("input",{type:"file",className:"form-control mb-2",accept:"image/*",onChange:o=>A(t,o),disabled:I===t}),I===t&&e.jsxs("small",{className:"text-muted d-block mb-2",children:["圖片 ",t+1," 上傳中..."]}),e.jsx("div",{className:"border rounded bg-light d-flex align-items-center justify-content-center position-relative",style:{height:"100px",overflow:"hidden"},children:a?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:a,alt:"預覽圖",className:"w-100 h-100 object-fit-cover",onError:o=>{o.target.src="https://via.placeholder.com/150?text=Invalid+URL"}}),e.jsx("button",{type:"button",className:"btn btn-danger btn-sm position-absolute top-0 end-0 p-1",style:{fontSize:"10px",lineHeight:1},onClick:()=>M(t),children:"✕"})]}):e.jsxs("small",{className:"text-muted",children:["圖片 ",t+1]})})]},t))})]})]})})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary","data-bs-dismiss":"modal",children:"關閉"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:l,children:"存檔"})]})]})})})}const H="https://ec-course-api.hexschool.io/v2",O="kentlee406";function q({getProductData:d,tempProduct:r}){const{showLoading:f,hideLoading:m}=n.useContext(P),{showNotification:b}=S(),i=async()=>{try{f(),await h.delete(`${H}/api/${O}/admin/product/${r.id}`),b("刪除成功","success",6e3),await d()}catch(s){const u=L(s.response?.data?.message||"發生錯誤");b(`刪除失敗：${u}`,"error",8e3)}finally{m()}};return e.jsx("div",{className:"modal fade",id:"deleteModal",tabIndex:"-1","aria-labelledby":"deleteModalLabel","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content border-0",children:[e.jsxs("div",{className:"modal-header bg-danger text-white",children:[e.jsx("h5",{className:"modal-title",id:"deleteModalLabel",children:e.jsx("span",{children:"刪除產品"})}),e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})]}),e.jsxs("div",{className:"modal-body",children:["是否刪除",e.jsxs("strong",{className:"text-danger",children:[" ",r.title," "]}),"(刪除後將無法恢復)。"]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary","data-bs-dismiss":"modal",children:"取消"}),e.jsx("button",{type:"button",className:"btn btn-danger",onClick:i,"data-bs-dismiss":"modal",children:"確認刪除"})]})]})})})}const _="https://ec-course-api.hexschool.io/v2",G="kentlee406";function ae(){const d=D(),{showLoading:r,hideLoading:f}=n.useContext(P),{showNotification:m}=S(),[b,i]=n.useState(1),[s,u]=n.useState([]),[w,y]=n.useState({}),[I,U]=n.useState(""),[j,p]=n.useState({id:"",imageUrl:"",title:"",category:"",unit:"",origin_price:"",price:"",description:"",content:"",is_enabled:!1,imagesUrl:[]}),c=(l,a)=>{U(l),p(l==="create"?{title:"",category:"",unit:"",origin_price:0,price:0,description:"",content:"",is_enabled:0,imageUrl:"",imagesUrl:[""]}:a);const t=document.getElementById("ProductModal");F.getOrCreateInstance(t).show()},N=async(l=b)=>{try{r();const a=await h.get(`${_}/api/${G}/admin/products?page=${l}`);u(a.data.products),y(a.data.pagination),i(a.data.pagination.current_page)}catch{m("取得後台產品資料失敗，請稍後再試","error",8e3)}finally{f()}},A=async()=>{const l=z();if(!l){m("登入狀態已失效，請重新登入","error",8e3),d("/login");return}try{r(),h.defaults.headers.common.Authorization=l,await h.post(`${_}/api/user/check`),await N(1)}catch{h.defaults.headers.common.Authorization="",m("登入狀態已失效，請重新登入","error",8e3),d("/login")}finally{f()}},M=async()=>{try{r(),await h.post(`${_}/logout`),R(),h.defaults.headers.common.Authorization="",d("/login")}catch{m("登出失敗，請稍後再試","error",8e3)}finally{f()}};return n.useEffect(()=>{A()},[]),e.jsxs("div",{className:"container",children:[e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-8",children:[e.jsxs("div",{className:"d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-3",children:[e.jsx("h2",{className:"fw-bold w-100 w-lg-auto mb-0",children:"產品列表"}),e.jsxs("div",{className:"d-flex flex-column flex-sm-row flex-wrap gap-2 w-100 w-lg-auto",children:[e.jsx("button",{className:"btn btn-success header-nav-btn",onClick:()=>c("create"),children:"新增產品"}),e.jsx("button",{className:"btn btn-success header-nav-btn",onClick:()=>d("/admin/order"),children:"訂單管理"}),e.jsx("button",{className:"btn btn-danger header-nav-btn",onClick:M,children:"登出"})]})]}),e.jsxs("table",{className:"table admin-responsive-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"分類"}),e.jsx("th",{children:"產品名稱"}),e.jsx("th",{children:"原價"}),e.jsx("th",{children:"售價"}),e.jsx("th",{children:"是否啟用"}),e.jsx("th",{children:"編輯"}),e.jsx("th",{children:"刪除"})]})}),e.jsx("tbody",{children:s&&s.length>0?s.map(l=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"分類",children:l.category}),e.jsx("td",{"data-label":"產品名稱",children:l.title}),e.jsx("td",{"data-label":"原價",children:l.origin_price}),e.jsx("td",{"data-label":"售價",children:l.price}),e.jsx("td",{"data-label":"是否啟用",children:l.is_enabled?"啟用":"未啟用"}),e.jsx("td",{"data-label":"編輯",children:e.jsx("button",{className:"btn btn-primary",onClick:()=>c("edit",l),children:"編輯"})}),e.jsx("td",{"data-label":"刪除",children:e.jsx("button",{type:"button",className:"btn btn-danger",id:"delete"+l.id,onClick:()=>p(l),"data-bs-target":"#deleteModal","data-bs-toggle":"modal",children:"刪除"})})]},l.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:"7",children:"尚無產品資料"})})})]})]})}),e.jsx(T,{products:s,pagination:w,currentPage:b,setCurrentPage:i,onPageChange:N}),e.jsx(B,{mode:I,tempProduct:j,getProductData:N}),e.jsx(q,{getProductData:N,tempProduct:j})]})}export{ae as default};
