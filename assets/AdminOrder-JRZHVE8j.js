import{r as d,k as e}from"./vendor-DCgf3J4u.js";import{b as E}from"./vendor-router-BS-I_zzl.js";import{a as h}from"./vendor-axios-B9ygI19o.js";import{a as C,u as _}from"./index-BWS5zvhs.js";import{g as F,c as R}from"./authToken-DvrakIaH.js";import{f as H}from"./formatApiErrorMessage-CWn7tMz1.js";import"./vendor-redux-B-LDsaQv.js";import"./vendor-bootstrap-DsuGXcVh.js";const U="https://ec-course-api.hexschool.io/v2",q="kentlee406";function B({tempOrder:n,getOrdersData:i,onDeleted:c}){const{showLoading:l,hideLoading:p}=d.useContext(C),{showNotification:x}=_(),[a,m]=d.useState(!1),g=o=>{if(!o)return"-";const r=new Date(o*1e3),f=r.getFullYear(),N=String(r.getMonth()+1).padStart(2,"0"),y=String(r.getDate()).padStart(2,"0"),v=String(r.getHours()).padStart(2,"0"),w=String(r.getMinutes()).padStart(2,"0"),b=String(r.getSeconds()).padStart(2,"0");return`${f}-${N}-${y} ${v}:${w}:${b}`},$=async()=>{if(!n?.id){x("查無可刪除的訂單","error",6e3);return}try{m(!0),l(),await h.delete(`${U}/api/${q}/admin/order/${n.id}`),x("刪除成功","success",6e3),await i(!1),c?.()}catch(o){const r=H(o.response?.data?.message||"發生錯誤");x(`刪除失敗：${r}`,"error",8e3)}finally{p(),m(!1)}};return e.jsx("div",{className:"modal fade",id:"deleteOrderModal",tabIndex:"-1","aria-labelledby":"deleteOrderModalLabel","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content border-0",children:[e.jsxs("div",{className:"modal-header bg-danger text-white",children:[e.jsx("h5",{className:"modal-title",id:"deleteOrderModalLabel",children:e.jsx("span",{children:"刪除訂單"})}),e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})]}),e.jsxs("div",{className:"modal-body",children:["是否刪除客戶在",e.jsx("strong",{className:"text-danger",children:` ${g(n?.create_at)} `}),"所建立的訂單資料？(刪除後將無法恢復)"]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary","data-bs-dismiss":"modal",children:"取消"}),e.jsx("button",{type:"button",className:"btn btn-danger",onClick:$,disabled:a,"data-bs-dismiss":"modal",children:a?"刪除中...":"確認刪除"})]})]})})})}const j="https://ec-course-api.hexschool.io/v2",O="kentlee406";function Z(){const n=E(),{showLoading:i,hideLoading:c}=d.useContext(C),{showNotification:l}=_(),[p,x]=d.useState(null),[a,m]=d.useState(null),[g,$]=d.useState(null),[o,r]=d.useState(!1),[f,N]=d.useState(""),y=d.useRef(!1),v=p?.orders||[],w=s=>{if(!s)return"-";const t=new Date(s*1e3),S=t.getFullYear(),k=String(t.getMonth()+1).padStart(2,"0"),A=String(t.getDate()).padStart(2,"0"),I=String(t.getHours()).padStart(2,"0"),T=String(t.getMinutes()).padStart(2,"0"),z=String(t.getSeconds()).padStart(2,"0");return`${S}-${k}-${A} ${I}:${T}:${z}`},b=(s=0)=>Number(s).toLocaleString("zh-TW"),u=d.useCallback(async(s=!0)=>{try{s&&i();const t=await h.get(`${j}/api/${O}/admin/orders`);return x(t.data),t.data}catch{return l("取得訂單資料失敗，請稍後再試","error",8e3),null}finally{s&&c()}},[i,c,l]),D=async(s,t)=>{try{N(s),i(),await h.put(`${j}/api/${O}/admin/order/${s}`,{data:{is_paid:t}});const S=await u(!1);if(a?.id===s&&S?.orders){const k=S.orders.find(A=>A.id===s);m(k||null)}l("訂單付款狀態已更新","success",5e3)}catch{l("更新付款狀態失敗，請稍後再試","error",8e3)}finally{c(),N("")}},L=async()=>{if(!(p?.orders?.length>0)){l("目前沒有訂單可刪除","error",5e3);return}try{r(!0),i(),await h.delete(`${j}/api/${O}/admin/orders/all`),l("已刪除全部訂單","success",5e3),await u(!1),m(null)}catch{l("刪除全部訂單失敗，請稍後再試","error",8e3)}finally{c(),r(!1)}},P=async()=>{try{i(),await h.post(`${j}/logout`),R(),h.defaults.headers.common.Authorization="",n("/login")}catch{l("登出失敗，請稍後再試","error",8e3)}finally{c()}},M=d.useCallback(async()=>{const s=F();if(!s){l("登入狀態已失效，請重新登入","error",8e3),n("/login");return}try{i(),h.defaults.headers.common.Authorization=s,await h.post(`${j}/api/user/check`),await u(!1)}catch{h.defaults.headers.common.Authorization="",l("登入狀態已失效，請重新登入","error",8e3),n("/login")}finally{c()}},[n,i,c,u]);return d.useEffect(()=>{y.current||(y.current=!0,M())},[M]),e.jsxs("div",{className:"container",children:[e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-10",children:[e.jsxs("div",{className:"d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-3",children:[e.jsx("h2",{className:"fw-bold w-100 w-lg-auto mb-0",children:"訂單管理"}),e.jsxs("div",{className:"d-flex flex-column flex-sm-row flex-wrap gap-2 w-100 w-lg-auto",children:[e.jsx("button",{type:"button",className:"btn btn-danger header-nav-btn","data-bs-toggle":"modal","data-bs-target":"#deleteAllOrdersModal",disabled:o,children:o?"刪除中...":"刪除全部訂單"}),e.jsx("button",{className:"btn btn-secondary header-nav-btn",onClick:()=>n("/admin/product"),children:"返回產品列表"}),e.jsx("button",{className:"btn btn-danger header-nav-btn",onClick:P,children:"登出"})]})]}),e.jsxs("table",{className:"table align-middle admin-responsive-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"訂單建立日期"}),e.jsx("th",{children:"訂購人姓名"}),e.jsx("th",{children:"訂購總額"}),e.jsx("th",{children:"是否已付款"}),e.jsx("th",{children:"操作"})]})}),e.jsx("tbody",{children:v.length>0?v.map(s=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"訂單建立日期",children:w(s.create_at)}),e.jsx("td",{"data-label":"訂購人姓名",children:s.user?.name||"-"}),e.jsxs("td",{"data-label":"訂購總額",children:["$",b(s.total)]}),e.jsx("td",{"data-label":"是否已付款",children:e.jsxs("div",{className:"form-check form-switch m-0",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",role:"switch",id:`isPaid-${s.id}`,checked:!!s.is_paid,disabled:f===s.id,onChange:t=>D(s.id,t.target.checked)}),e.jsx("label",{className:"form-check-label",htmlFor:`isPaid-${s.id}`,children:s.is_paid?"已付款":"未付款"})]})}),e.jsxs("td",{"data-label":"操作",children:[e.jsx("button",{type:"button",className:"btn btn-primary me-2","data-bs-toggle":"modal","data-bs-target":"#orderDetailModal",onClick:()=>m(s),children:"查看訂單細目"}),e.jsx("button",{type:"button",className:"btn btn-danger","data-bs-toggle":"modal","data-bs-target":"#deleteOrderModal",onClick:()=>$(s),children:"刪除訂單"})]})]},s.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:"5",children:"目前尚無訂單資料"})})})]})]})}),e.jsx("div",{className:"modal fade",id:"orderDetailModal",tabIndex:"-1","aria-labelledby":"orderDetailModalLabel","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-xl",children:e.jsxs("div",{className:"modal-content border-0",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title fw-bold",id:"orderDetailModalLabel",children:"訂單細目"}),e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})]}),e.jsx("div",{className:"modal-body",children:a?e.jsx("div",{className:"container-fluid",children:e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-12 col-lg-6",children:e.jsxs("div",{className:"border rounded p-3 h-100",children:[e.jsx("h6",{className:"fw-bold",children:"訂購人資料"}),e.jsxs("p",{className:"mb-1",children:["姓名：",a.user?.name||"-"]}),e.jsxs("p",{className:"mb-1",children:["電子郵件：",a.user?.email||"-"]}),e.jsxs("p",{className:"mb-1",children:["地址：",a.user?.address||"-"]}),e.jsxs("p",{className:"mb-0",children:["電話：",a.user?.tel||"-"]})]})}),e.jsx("div",{className:"col-12 col-lg-6",children:e.jsxs("div",{className:"border rounded p-3 h-100",children:[e.jsx("h6",{className:"fw-bold",children:"訂單資料"}),e.jsxs("p",{className:"mb-1",children:["訂單編號：",a.id||"-"]}),e.jsxs("p",{className:"mb-1",children:["建立時間：",w(a.create_at)]}),e.jsxs("div",{className:"mb-2 d-flex align-items-center",children:[e.jsx("span",{className:"me-2",children:"是否付款："}),e.jsxs("div",{className:"form-check form-switch m-0",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"detail-is-paid",checked:!!a.is_paid,disabled:f===a.id,onChange:s=>D(a.id,s.target.checked)}),e.jsx("label",{className:"form-check-label",htmlFor:"detail-is-paid",children:a.is_paid?"已付款":"未付款"})]})]}),e.jsxs("p",{className:"mb-1 fw-bold",children:["訂單總金額：$",b(a.total)]}),e.jsxs("p",{className:"mb-0",children:["備註：",a.message||"-"]})]})}),e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"border rounded p-3",children:[e.jsx("h6",{className:"fw-bold",children:"訂單細目"}),e.jsxs("table",{className:"table align-middle mb-0",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"產品主圖"}),e.jsx("th",{children:"產品名稱"}),e.jsx("th",{children:"產品類別"}),e.jsx("th",{children:"訂購數量"}),e.jsx("th",{children:"單價"}),e.jsx("th",{children:"金額"})]})}),e.jsx("tbody",{children:Object.values(a.products||{}).length>0?Object.values(a.products||{}).map(s=>{const t=s.final_total||s.total||Number(s.qty||0)*Number(s.product?.price||0);return e.jsxs("tr",{children:[e.jsx("td",{children:s.product?.imageUrl?e.jsx("img",{src:s.product.imageUrl,alt:s.product?.title||"產品主圖",style:{width:"64px",height:"64px",objectFit:"cover"},className:"rounded border"}):"-"}),e.jsx("td",{children:s.product?.title||"-"}),e.jsx("td",{children:s.product?.category||"-"}),e.jsx("td",{children:s.qty||0}),e.jsxs("td",{children:["$",b(s.product?.price||0)]}),e.jsxs("td",{children:["$",b(t)]})]},s.id||s.product_id)}):e.jsx("tr",{children:e.jsx("td",{colSpan:"6",children:"此訂單無商品資料"})})})]})]})})]})}):e.jsx("p",{className:"mb-0",children:"尚未選擇訂單"})}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{type:"button",className:"btn btn-secondary","data-bs-dismiss":"modal",children:"關閉"})})]})})}),e.jsx("div",{className:"modal fade",id:"deleteAllOrdersModal",tabIndex:"-1","aria-labelledby":"deleteAllOrdersModalLabel","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content border-0",children:[e.jsxs("div",{className:"modal-header bg-danger text-white",children:[e.jsx("h5",{className:"modal-title",id:"deleteAllOrdersModalLabel",children:e.jsx("span",{children:"刪除全部訂單"})}),e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})]}),e.jsxs("div",{className:"modal-body",children:["是否刪除",e.jsx("strong",{className:"text-danger",children:" 全部訂單 "}),"(刪除後將無法恢復)。"]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary","data-bs-dismiss":"modal",children:"取消"}),e.jsx("button",{type:"button",className:"btn btn-danger",onClick:L,disabled:o,"data-bs-dismiss":"modal",children:o?"刪除中...":"確認刪除"})]})]})})}),e.jsx(B,{tempOrder:g,getOrdersData:u,onDeleted:()=>{a?.id===g?.id&&m(null)}})]})}export{Z as default};
